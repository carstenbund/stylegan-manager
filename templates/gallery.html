<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walk Gallery</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        h1, h2, p { text-align: center; }
        a { color: #007bff; }
        .controls { text-align: center; margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .walk { margin-bottom: 40px; }
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .img-container { position: relative; cursor: pointer; }
        .img-container img { width: 100%; height: auto; display: block; border-radius: 8px; transition: transform 0.2s; }
        .img-container input { display: none; }
        .img-container .selection-order {
            position: absolute; top: 5px; right: 5px; background-color: #007bff; color: white;
            width: 24px; height: 24px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-weight: bold;
            border: 2px solid white; display: none;
        }
        .img-container .like-btn {
            position: absolute; bottom: 5px; left: 5px;
            width: 28px; height: 28px; border-radius: 50%;
            border: none; background: rgba(255,255,255,0.8);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; cursor: pointer; color: #bbb;
        }
        .img-container .like-btn.liked { color: #dc3545; }
        .img-container input:checked + img {
            box-shadow: 0 0 0 4px #007bff;
            transform: scale(0.95);
        }
        .img-container input:checked ~ .selection-order {
            display: flex;
        }
        #createWalkBtn { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; background-color: #28a745; color: white; }
        #createWalkBtn:hover { background-color: #218838; }
        .archive-walk { padding: 5px 10px; margin-left: 10px; font-size: 14px; cursor: pointer; border-radius: 4px; border: none; background-color: #6c757d; color: white; }
        .archive-walk:hover { background-color: #5a6268; }
        .delete-walk { padding: 5px 10px; margin-left: 10px; font-size: 14px; cursor: pointer; border-radius: 4px; border: none; background-color: #dc3545; color: white; }
        .delete-walk:hover { background-color: #c82333; }
        .info-walk { padding: 5px 10px; margin-left: 10px; font-size: 14px; cursor: pointer; border-radius: 4px; border: none; background-color: #007bff; color: white; }
        .info-walk:hover { background-color: #0069d9; }
        .play-video, .download-video, .enqueue-walk { padding: 5px 10px; margin-left: 10px; font-size: 14px; cursor: pointer; border-radius: 4px; border: none; background-color: #28a745; color: white; }
        .play-video:hover, .download-video:hover, .enqueue-walk:hover { background-color: #218838; }
        summary { cursor: pointer; list-style: none; }
        summary::-webkit-details-marker { display: none; }
        .thumbs { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .walk[open] .thumbs { display: none; }
        .thumbs img { width: 150px; height: auto; border-radius: 8px; }
        #videoOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; }
        #videoOverlay video { max-width:90%; max-height:90%; }
        #infoOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; }
        #infoPane { background:#fff; padding:20px; border-radius:8px; width:300px; }
        #infoPane label { display:block; margin-bottom:10px; }
        #infoPane input, #infoPane textarea { width:100%; }
    </style>
</head>
<body>
    <h1>Walk Gallery</h1>
    <p>Select images in the order you want to create a new walk. <a href="/">Back to Generator</a> | <a href="/archive">Archived Walks</a></p>

    <div class="controls">
        <label><input type="checkbox" id="likedOnlyToggle" {% if filters.liked %}checked{% endif %}> Show liked only</label>
    </div>

    <div class="controls">
        <label for="stepsInput">Steps per leg:</label>
        <input type="number" id="stepsInput" value="60" min="2" style="width: 80px;">
        <label><input type="checkbox" id="loopInput"> Loop walk</label>
        <label><input type="checkbox" id="queueInput" checked> Queue</label>
        <button id="createWalkBtn">Create Custom Walk From Selection</button>
        <p id="status"></p>
    </div>

    <div id="queueStatus" class="controls">
        <h2>Render Queue</h2>
        <ul id="queueList"></ul>
    </div>

    {% for walk in walks %}
    {% set images = images_by_walk.get(walk[0], []) %}
    <details class="walk">
        <summary>
            <h2>Walk {{ walk[0] }}: {{ walk[1] }} ({{ walk[2] }}, step rate {{ walk[4] }})
                <button type="button" class="archive-walk" data-walk-id="{{ walk[0] }}" onclick="event.stopPropagation();">Archive</button>
                <button type="button" class="delete-walk" data-walk-id="{{ walk[0] }}" onclick="event.stopPropagation();">Delete</button>
                <button type="button" class="info-walk" data-walk-id="{{ walk[0] }}" onclick="event.stopPropagation();">Info</button>
                <button type="button" class="enqueue-walk" data-walk-id="{{ walk[0] }}" onclick="event.stopPropagation();">Render</button>
                {% if videos_by_walk.get(walk[0]) %}
                <button type="button" class="play-video" data-walk-id="{{ walk[0] }}" onclick="event.stopPropagation();">Play Video</button>
                <button type="button" class="download-video" data-walk-id="{{ walk[0] }}" onclick="event.stopPropagation();">Download Video</button>
                {% endif %}
            </h2>
            <div class="thumbs">
                {% if images %}
                <img src="{{ url_for('serve_generated_image', walk_id=walk[0], filename=images[0].filename) }}" alt="start image">
                {% if images|length > 1 %}
                <img src="{{ url_for('serve_generated_image', walk_id=walk[0], filename=images[-1].filename) }}" alt="end image">
                {% endif %}
                {% endif %}
            </div>
        </summary>
        <div class="gallery">
            {% for image in images %}
            <label class="img-container">
                <input type="checkbox" name="image_selection" value="{{ image.id }}">
                <img src="{{ url_for('serve_generated_image', walk_id=walk[0], filename=image.filename) }}" alt="{{ image.filename }}" loading="lazy">
                <div class="selection-order"></div>
                <button type="button" class="like-btn{% if image.liked %} liked{% endif %}" data-image-id="{{ image.id }}">{{ '♥' if image.liked else '♡' }}</button>
            </label>
            {% endfor %}
        </div>
    </details>
    {% endfor %}

    <div id="videoOverlay">
        <video id="walkVideo" controls></video>
    </div>

    <div id="infoOverlay">
        <div id="infoPane">
            <h3>Edit Walk Info</h3>
            <form id="infoForm">
                <input type="hidden" id="infoWalkId">
                <label>Name: <input type="text" id="infoName"></label>
                <label>Step Rate: <input type="number" id="infoStepRate" min="1"></label>
                <label>Note:<br><textarea id="infoNote"></textarea></label>
                <button type="submit">Save</button>
                <button type="button" id="infoCancel">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const createWalkBtn = document.getElementById('createWalkBtn');
            const statusEl = document.getElementById('status');
            const stepsInput = document.getElementById('stepsInput');
            const loopInput = document.getElementById('loopInput');
            const queueInput = document.getElementById('queueInput');
            const queueList = document.getElementById('queueList');
            const infoOverlay = document.getElementById('infoOverlay');
            const infoForm = document.getElementById('infoForm');
            const infoCancel = document.getElementById('infoCancel');
            const infoWalkId = document.getElementById('infoWalkId');
            const infoName = document.getElementById('infoName');
            const infoStepRate = document.getElementById('infoStepRate');
            const infoNote = document.getElementById('infoNote');
            const likedOnlyToggle = document.getElementById('likedOnlyToggle');
            let selectedIds = [];
            let lastRendering = null;

            function fetchQueueStatus() {
                return fetch('/queue_status')
                .then(res => res.json())
                .then(data => {
                    if (lastRendering && data.rendering !== lastRendering) {
                        window.location.reload();
                        return data;
                    }
                    lastRendering = data.rendering;
                    queueList.innerHTML = '';
                    if (data.rendering) {
                        const li = document.createElement('li');
                        li.textContent = `Rendering walk ${data.rendering}`;
                        const btn = document.createElement('button');
                        btn.textContent = 'Cancel';
                        btn.addEventListener('click', () => cancelWalk(data.rendering));
                        li.appendChild(btn);
                        queueList.appendChild(li);
                    }
                    (data.preparing || []).forEach(id => {
                        const li = document.createElement('li');
                        li.textContent = `Preparing walk ${id}`;
                        const btn = document.createElement('button');
                        btn.textContent = 'Cancel';
                        btn.addEventListener('click', () => cancelWalk(id));
                        li.appendChild(btn);
                        queueList.appendChild(li);
                    });
                    data.pending.forEach(id => {
                        const li = document.createElement('li');
                        li.textContent = `Queued walk ${id}`;
                        const btn = document.createElement('button');
                        btn.textContent = 'Cancel';
                        btn.addEventListener('click', () => cancelWalk(id));
                        li.appendChild(btn);
                        queueList.appendChild(li);
                    });
                    return data;
                });
            }

            function cancelWalk(id) {
                fetch(`/queue_item/${id}`, { method: 'DELETE' })
                .then(() => fetchQueueStatus());
            }

            fetchQueueStatus();
            setInterval(fetchQueueStatus, 5000);

            function updateFilters(newFilters) {
                const params = new URLSearchParams(window.location.search);
                Object.entries(newFilters).forEach(([key, value]) => {
                    if (value === null || value === undefined || value === false) {
                        params.delete(key);
                    } else {
                        params.set(key, value);
                    }
                });
                window.location.search = params.toString();
            }

            if (likedOnlyToggle) {
                likedOnlyToggle.addEventListener('change', () => {
                    updateFilters({ liked: likedOnlyToggle.checked ? '1' : null });
                });
            }

            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const imageId = btn.getAttribute('data-image-id');
                    const isLiked = btn.classList.contains('liked');
                    fetch(`/image/${imageId}/like`, { method: isLiked ? 'DELETE' : 'POST' })
                    .then(res => {
                        if (!res.ok) { throw new Error('Failed to update'); }
                        btn.classList.toggle('liked');
                        btn.textContent = btn.classList.contains('liked') ? '♥' : '♡';
                        if (likedOnlyToggle && likedOnlyToggle.checked && !btn.classList.contains('liked')) {
                            btn.closest('.img-container').remove();
                        }
                    })
                    .catch(err => console.error('Error:', err));
                });
            });

            document.querySelectorAll('.gallery').forEach(gallery => {
                gallery.addEventListener('change', (event) => {
                    if (event.target.type === 'checkbox') {
                        const id = event.target.value;
                        const container = event.target.closest('.img-container');
                        const orderBadge = container.querySelector('.selection-order');

                        if (event.target.checked) {
                            selectedIds.push(id);
                            orderBadge.textContent = selectedIds.length;
                        } else {
                            const index = selectedIds.indexOf(id);
                            if (index > -1) selectedIds.splice(index, 1);
                            updateBadges();
                        }
                    }
                });
            });

            function updateBadges() {
                document.querySelectorAll('.img-container input').forEach(checkbox => {
                    const id = checkbox.value;
                    const orderBadge = checkbox.closest('.img-container').querySelector('.selection-order');
                    const index = selectedIds.indexOf(id);
                    orderBadge.textContent = index > -1 ? index + 1 : '';
                });
            }

            createWalkBtn.addEventListener('click', () => {
                if (selectedIds.length < 2) {
                    alert('Please select at least two images to create a walk.');
                    return;
                }

                statusEl.textContent = 'Creating custom walk...';

                const steps = parseInt(stepsInput.value, 10) || 60;
                fetch('/create_custom_walk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: selectedIds, steps: steps, loop: loopInput.checked, queue: queueInput.checked })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' || data.status === 'queued') {
                        if (queueInput.checked) {
                            statusEl.textContent = `Walk ${data.walk_id} queued for rendering.`;
                            fetchQueueStatus();
                        } else {
                            statusEl.textContent = `Success! New walk with ID ${data.walk_id} created.`;
                            alert('Custom walk created! You will now be redirected to the main page.');
                            window.location.href = '/index?autoplay=true';
                        }
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusEl.textContent = `Error: ${error.message}`;
                    alert(`Error: ${error.message}`);
                });
            });

            document.querySelectorAll('.archive-walk').forEach(btn => {
                btn.addEventListener('click', () => {
                    const walkId = btn.getAttribute('data-walk-id');
                    if (!confirm(`Archive walk ${walkId}?`)) return;
                    const note = prompt('Enter a note for this walk (optional):') || '';

                    fetch(`/archive_walk/${walkId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ note })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`Walk ${walkId} archived.`);
                            window.location.reload();
                        } else {
                            throw new Error(data.message || 'Failed to archive walk');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert(`Error: ${error.message}`);
                    });
                });
            });

            document.querySelectorAll('.delete-walk').forEach(btn => {
                btn.addEventListener('click', () => {
                    const walkId = btn.getAttribute('data-walk-id');
                    if (!confirm(`Delete walk ${walkId}? This cannot be undone.`)) return;

                    fetch(`/delete_walk/${walkId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`Walk ${walkId} deleted.`);
                            window.location.reload();
                        } else {
                            throw new Error(data.message || 'Failed to delete walk');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert(`Error: ${error.message}`);
                    });
                });
            });

            document.querySelectorAll('.info-walk').forEach(btn => {
                btn.addEventListener('click', () => {
                    const walkId = btn.getAttribute('data-walk-id');
                    fetch(`/walk_info/${walkId}`)
                    .then(res => res.json())
                    .then(data => {
                        infoWalkId.value = walkId;
                        infoName.value = data.name || '';
                        infoStepRate.value = data.step_rate || '';
                        infoNote.value = data.note || '';
                        infoOverlay.style.display = 'flex';
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        alert('Failed to load walk info');
                    });
                });
            });

            infoCancel.addEventListener('click', () => {
                infoOverlay.style.display = 'none';
            });

            infoForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = infoWalkId.value;
                const payload = {
                    name: infoName.value.trim(),
                    step_rate: parseInt(infoStepRate.value, 10),
                    note: infoNote.value
                };
                if (!payload.name) {
                    alert('Name cannot be empty');
                    return;
                }
                if (isNaN(payload.step_rate) || payload.step_rate <= 0) {
                    alert('Step rate must be a positive integer');
                    return;
                }
                fetch(`/walk_info/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        infoOverlay.style.display = 'none';
                        window.location.reload();
                    } else {
                        throw new Error(data.message || 'Update failed');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert(`Error: ${err.message}`);
                });
            });

            document.querySelectorAll('.enqueue-walk').forEach(btn => {
                btn.addEventListener('click', () => {
                    const walkId = btn.getAttribute('data-walk-id');
                    const steps = parseInt(stepsInput.value, 10) || 60;
                    const request = fetch(`/enqueue_walk/${walkId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ steps })
                    });

                    const placeholder = document.createElement('li');
                    placeholder.textContent = 'Preparing...';
                    queueList.appendChild(placeholder);
                    fetchQueueStatus();

                    request
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server responded with ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const newId = data.walk_id;
                        alert(`Walk ${newId} queued for rendering.`);
                        const poll = setInterval(() => {
                            fetchQueueStatus().then(status => {
                                const preparing = status.preparing || [];
                                if (!preparing.includes(newId)) {
                                    clearInterval(poll);
                                }
                            });
                        }, 1000);
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        alert(`Failed to queue walk ${walkId}.`);
                    });
                });
            });

            document.querySelectorAll('.play-video').forEach(btn => {
                btn.addEventListener('click', () => {
                    const walkId = btn.getAttribute('data-walk-id');
                    const overlay = document.getElementById('videoOverlay');
                    const video = document.getElementById('walkVideo');
                    video.src = `/generated_videos/${walkId}/walk.mp4`;
                    overlay.style.display = 'flex';
                    video.play();
                });
            });

            document.querySelectorAll('.download-video').forEach(btn => {
                btn.addEventListener('click', () => {
                    const walkId = btn.getAttribute('data-walk-id');
                    const link = document.createElement('a');
                    link.href = `/generated_videos/${walkId}/walk.mp4`;
                    link.download = `walk_${walkId}.mp4`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            });

            document.getElementById('videoOverlay').addEventListener('click', (e) => {
                if (e.target.id === 'videoOverlay') {
                    const overlay = document.getElementById('videoOverlay');
                    const video = document.getElementById('walkVideo');
                    video.pause();
                    video.removeAttribute('src');
                    overlay.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
