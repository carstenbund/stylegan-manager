<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walk Gallery</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        h1, h2, p { text-align: center; }
        a { color: #007bff; }
        .controls { text-align: center; margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .walk { margin-bottom: 40px; }
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .img-container { position: relative; cursor: pointer; }
        .img-container img { width: 100%; height: auto; display: block; border-radius: 8px; transition: transform 0.2s; }
        .img-container input { display: none; }
        .img-container .selection-order {
            position: absolute; top: 5px; right: 5px; background-color: #007bff; color: white;
            width: 24px; height: 24px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-weight: bold;
            border: 2px solid white; display: none;
        }
        .img-container input:checked + img {
            box-shadow: 0 0 0 4px #007bff;
            transform: scale(0.95);
        }
        .img-container input:checked ~ .selection-order {
            display: flex;
        }
        #createWalkBtn { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; background-color: #28a745; color: white; }
        #createWalkBtn:hover { background-color: #218838; }
        .delete-walk { padding: 5px 10px; margin-left: 10px; font-size: 14px; cursor: pointer; border-radius: 4px; border: none; background-color: #dc3545; color: white; }
        .delete-walk:hover { background-color: #c82333; }
        summary { cursor: pointer; list-style: none; }
        summary::-webkit-details-marker { display: none; }
        .thumbs { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .thumbs img { width: 150px; height: auto; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>Walk Gallery</h1>
    <p>Select images in the order you want to create a new walk. <a href="/">Back to Generator</a></p>

    <div class="controls">
        <label for="stepsInput">Steps per leg:</label>
        <input type="number" id="stepsInput" value="60" min="2" style="width: 80px;">
        <button id="createWalkBtn">Create Custom Walk From Selection</button>
        <p id="status"></p>
    </div>

    {% for walk in walks %}
    {% set images = images_by_walk.get(walk[0], []) %}
    <details class="walk">
        <summary>
            <h2>Walk {{ walk[0] }}: {{ walk[1] }} ({{ walk[2] }}, step rate {{ walk[4] }}) <button class="delete-walk" data-walk-id="{{ walk[0] }}" onclick="event.stopPropagation();">Delete</button></h2>
            <div class="thumbs">
                {% if images %}
                <img src="{{ url_for('serve_generated_image', instance_id=images[0].instance_id, rand8=images[0].rand8, filename=images[0].filename) }}" alt="start image">
                {% if images|length > 1 %}
                <img src="{{ url_for('serve_generated_image', instance_id=images[-1].instance_id, rand8=images[-1].rand8, filename=images[-1].filename) }}" alt="end image">
                {% endif %}
                {% endif %}
            </div>
        </summary>
        <div class="gallery">
            {% for image in images %}
            <label class="img-container">
                <input type="checkbox" name="image_selection" value="{{ image.id }}">
                <img src="{{ url_for('serve_generated_image', instance_id=image.instance_id, rand8=image.rand8, filename=image.filename) }}" alt="{{ image.filename }}" loading="lazy">
                <div class="selection-order"></div>
            </label>
            {% endfor %}
        </div>
    </details>
    {% endfor %}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const createWalkBtn = document.getElementById('createWalkBtn');
            const statusEl = document.getElementById('status');
            const stepsInput = document.getElementById('stepsInput');
            let selectedIds = [];

            document.querySelectorAll('.gallery').forEach(gallery => {
                gallery.addEventListener('change', (event) => {
                    if (event.target.type === 'checkbox') {
                        const id = event.target.value;
                        const container = event.target.closest('.img-container');
                        const orderBadge = container.querySelector('.selection-order');

                        if (event.target.checked) {
                            selectedIds.push(id);
                            orderBadge.textContent = selectedIds.length;
                        } else {
                            const index = selectedIds.indexOf(id);
                            if (index > -1) selectedIds.splice(index, 1);
                            updateBadges();
                        }
                    }
                });
            });

            function updateBadges() {
                document.querySelectorAll('.img-container input').forEach(checkbox => {
                    const id = checkbox.value;
                    const orderBadge = checkbox.closest('.img-container').querySelector('.selection-order');
                    const index = selectedIds.indexOf(id);
                    orderBadge.textContent = index > -1 ? index + 1 : '';
                });
            }

            createWalkBtn.addEventListener('click', () => {
                if (selectedIds.length < 2) {
                    alert('Please select at least two images to create a walk.');
                    return;
                }

                statusEl.textContent = 'Creating custom walk...';

                const steps = parseInt(stepsInput.value, 10) || 60;
                fetch('/create_custom_walk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: selectedIds, steps: steps })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        statusEl.textContent = `Success! New walk with ID ${data.walk_id} created.`;
                        alert('Custom walk created! You will now be redirected to the main page.');
                        window.location.href = '/index?autoplay=true';
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusEl.textContent = `Error: ${error.message}`;
                    alert(`Error: ${error.message}`);
                });
            });

            document.querySelectorAll('.delete-walk').forEach(btn => {
                btn.addEventListener('click', () => {
                    const walkId = btn.getAttribute('data-walk-id');
                    if (!confirm(`Delete walk ${walkId}?`)) return;

                    fetch(`/delete_walk/${walkId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`Walk ${walkId} deleted.`);
                            window.location.reload();
                        } else {
                            throw new Error(data.message || 'Failed to delete walk');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert(`Error: ${error.message}`);
                    });
                });
            });
        });
    </script>
</body>
</html>
